
CREATE TABLE tag (
    tagName VARCHAR(50) PRIMARY KEY CHECK(tagName IN ('movie', 'funny', 'logic', 'science', 'classic'))
);


CREATE TABLE charadeTag (
    charadeTagID INT PRIMARY KEY,
    charadeID INT NOT NULL,
    tagID VARCHAR(50) NOT NULL,
    FOREIGN KEY (charadeID) REFERENCES charade(charadeID),
    FOREIGN KEY (tagID) REFERENCES tag(tagName)
);



CREATE TABLE charade (
    charadeID INT PRIMARY KEY,
    charadeType VARCHAR(1) NOT NULL CHECK (charadeType IN ('m', 's')), 
    difficulty VARCHAR(10) NOT NULL CHECK (difficulty IN ('easy', 'medium', 'hard')),
    origin VARCHAR(50),
    description VARCHAR(255) NOT NULL,
    answer VARCHAR(50) NOT NULL
);


CREATE TABLE multipleChoice (
    multipleChoiceID INT PRIMARY KEY,
    charadeID INT NOT NULL,
    optionText VARCHAR(50) NOT NULL,
    isCorrect BIT NOT NULL,
    FOREIGN KEY (charadeID) REFERENCES charade(charadeID) 

);

CREATE TRIGGER BeforeInsertMultipleChoice
ON multipleChoice
INSTEAD OF INSERT
AS
BEGIN

    DECLARE @v_charadeType CHAR(1);


    DECLARE @charadeID INT;
    DECLARE inserted_cursor CURSOR FOR
        SELECT charadeID FROM inserted;
    OPEN inserted_cursor;

    FETCH NEXT FROM inserted_cursor INTO @charadeID;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        
        SELECT @v_charadeType = charadeType FROM charade WHERE charadeID = @charadeID;

       
        IF @v_charadeType <> 'm'
        BEGIN
            THROW 50000, 'Invalid entry: only multiple choice riddles can have multiple choice options', 1;
        END

        FETCH NEXT FROM inserted_cursor INTO @charadeID;
    END

    CLOSE inserted_cursor;
    DEALLOCATE inserted_cursor;

    INSERT INTO multipleChoice (multipleChoiceID, charadeID, optionText, isCorrect)
        SELECT multipleChoiceID, charadeID, optionText, isCorrect FROM inserted;
END

CREATE TRIGGER CheckUniqueCorrectOption
ON multipleChoice
INSTEAD OF INSERT
AS
BEGIN
    DECLARE @charadeID INT;

    SELECT @charadeID = charadeID
    FROM inserted
    WHERE isCorrect = 1;

    IF ((SELECT COUNT(*) FROM inserted) > 1 OR
    EXISTS (SELECT 1 FROM multipleChoice WHERE charadeID = @charadeID AND isCorrect = 1))
    BEGIN
        RAISERROR ('Only one correct option is allowed per charade.', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END;
END;

INSERT INTO tag (tagName) VALUES
    ('movie'),
    ('funny'),
    ('logic'),
    ('science'),
    ('classic');

INSERT INTO charade (charadeID, charadeType , difficulty, origin, description, answer) VALUES
    (1, 'm', 'medium', NULL, 'I speak without a mouth and hear without ears. I have no body, but I come alive with wind. What am I?', 'An Echo');

INSERT INTO charade (charadeID, charadeType , difficulty, origin, description, answer) VALUES
    (2, 's', 'medium', NULL, 'What is as light as a feather, yet the strongest person can''t hold it for more than a few minutes?', 'Breath');

INSERT INTO multipleChoice (multipleChoiceID, charadeID, optionText, isCorrect) VALUES
    (1, 1, 'Breath', 1),
    (2, 1, 'A bubble', 0),
    (3, 1, 'A thought', 1)
    (4, 1, 'A cloud', 0);

